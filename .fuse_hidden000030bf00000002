#!/bin/bash

# --- 1. Configuration ---
APP_NAME="CW_Trainer-GNR"
ROOT_DIR=$(pwd)
BUILD_DIR="$ROOT_DIR/build-windows"
ASSETS_DIR="$ROOT_DIR/Build_Assets"
OUTPUT_DIR="$ROOT_DIR/Download/Windows"
SRC_DIR="$ROOT_DIR/Source_code"
QMAKE_BIN="x86_64-w64-mingw32-qmake-qt6"

# Cleanup unwanted old subfolders in Download
mkdir -p "$OUTPUT_DIR"
rm -rf "$OUTPUT_DIR/Downloader" "$OUTPUT_DIR/Portable"

echo "======================================================="
echo "üöÄ MASTER BUILDER: $APP_NAME"
echo "======================================================="

# --- 2. Interactive Input ---
read -p "Enter Version (e.g., 1.0.1): " VERSION_NUM
echo "Select Flag: 1) STBL, 2) DEV, 3) BETA"
read -p "Choice [1-3]: " FLAG_CHOICE
case $FLAG_CHOICE in
    1) VERSION_FLAG="STBL" ;;
    2) VERSION_FLAG="DEV" ;;
    *) VERSION_FLAG="BETA" ;;
esac

FULL_VERSION="${VERSION_NUM}-${VERSION_FLAG}"
PORTABLE_NAME="${APP_NAME}_v${FULL_VERSION}_Portable.zip"
INSTALLER_NAME="${APP_NAME}_v${FULL_VERSION}_Setup.exe"

read -p "Confirm build $FULL_VERSION? (y/n): " CONFIRM
[[ $CONFIRM != "y" ]] && exit 0

START_TIME=$SECONDS

# --- 3. THE COMPILATION ---
echo "üî® Compiling from source..."
cd "$BUILD_DIR" || exit
make clean
$QMAKE_BIN "$SRC_DIR/CW_Trainer-GNR.pro" -spec win32-g++
make -j$(nproc)

if [ ! -f "release/CW_Trainer-GNR.exe" ]; then
    echo "‚ùå ERROR: Compilation failed. No EXE created."
    exit 1
fi

# --- 4. VERIFICATION (The "Why is Setup failing?" Check) ---
echo "üîç Verifying assets before packaging..."
if [ ! -d "$ASSETS_DIR/platforms" ]; then
    echo "‚ùå ERROR: $ASSETS_DIR/platforms is missing!"
    exit 1
fi

# --- 5. PACKAGING ---
echo "üì¶ Creating Portable ZIP..."
cd "$ASSETS_DIR" || exit
zip -r "$OUTPUT_DIR/$PORTABLE_NAME" . -x "installer.nsi" "*.exe"

echo "üõ†Ô∏è Building Setup EXE..."
# Run makensis and capture any specific error messages
makensis -V4 -DVERSION_NUM="$VERSION_NUM" -DVERSION_FLAG="$VERSION_FLAG" installer.nsi

# Final Check
if [ -f "$OUTPUT_DIR/$INSTALLER_NAME" ]; then
    echo "‚úÖ Success! Installer created."
else
    echo "‚ùå ERROR: makensis finished but $INSTALLER_NAME was not found in $OUTPUT_DIR."
fi

# --- 6. FINISH ---
DURATION=$(( SECONDS - START_TIME ))
echo "======================================================="
echo "üéâ Done in $((DURATION / 60))m $((DURATION % 60))s"
ls -lh "$OUTPUT_DIR" | grep "$FULL_VERSION"
for i in {1..3}; do echo -ne "\a"; sleep 0.2; done
